{% extends "base_generic.html" %}
{% block title %}
    <title>Создать модель</title>
{% endblock %}
{% block navbar%}
    <nav class="nav nav-pills navigation">
      {% if user.is_authenticated %}
        <a class="nav-link" href="/">Все данные</a>
        <a class="nav-link" href="{% url 'dataset_detail' pk=dataset_pk %}">Датасет: {{title}}</a>
        <a class="nav-link" href="{% url 'models' pk=dataset_pk %}">Список моделей</a>
        <a class="nav-link active" href="{% url 'add_model' pk=dataset_pk %}">Создать новую модель</a>
        <a class="nav-link" href="{% url 'logout'%}?next={{request.path}}">Выйти</a>
      {% else %}
        <a class="nav-link" href="{% url 'login'%}?next={{request.path}}">Войти</a>
        <a class="nav-link" href="{% url 'register'%}?next={{request.path}}">Регистрация</a>  
      {% endif %} 
    </nav>
{% endblock %}
{% block content %}
  <div class= "flex">
    <form style= "width: 35%;" id="model_form" method="POST">
      <h4>Создать модель</h4>
      {% csrf_token %}
      <div class="form-group col-md-20">
        <label for="id_modelType">Тип модели:</label>
        <select class= "form-control" name="modelType" id="id_modelType">
          <option value="Кластеризация методом k-средних">Кластеризация методом k-средних</option>
          <option value="Кластеризация методом DBSCAN">Кластеризация методом DBSCAN</option>
          {% if class %}
          <option value="Классификация деревом решений">Классификация с помощью дерева решений</option>
          <option value="Классификация случайным лесом">Классификация с помощью случайного леса</option>
          {% endif %}
        </select>
      </div>
      <button style= "margin-left: 15px;" class= "btn btn-light" id= "btn-params" type= "button">Дополнительные параметры<i style= "margin-left: 2px; font-size: 14px; font-weight: lighter" id= "btn-icon" class="fa fa-chevron-down"></i></button>
      <br>
      <div style= "display:none" id= "model-params">
        <div class="model1 form-group col-md-6">
          <label for="id_minClusters">Минимальное количество кластеров:</label>
          <input class= "form-control" type="number" name="minClusters" required="" id="id_minClusters" min = "2" value= "2" max = "{{samples}}">
        </div>
        <div class="model1 form-group col-md-6">
          <label for="id_maxClusters">Максимальное количество кластеров:</label>
          <input class= "form-control" type="number" name="maxClusters" required="" id="id_maxClusters" min = "2" value = "{{samples}}" max = "{{samples}}">
        </div>
        <div class= "model2" style = "display: none;"> У этого типа модели нет дополнительных параметров.</div>
        <div style = "display: none;" class="model3 form-group col-md-10">
          <label for="id_parameterSearchMethod">Метод поиска параметров:</label>
          <select class= "form-control" name="parameterSearchMethod" id="id_parameterSearchMethod">
            <option value="Randomized search">Случайный поиск</option>       
            <option value="Grid search">Поиск по сетке</option>        
          </select>
        </div>
      </div>
      <button style= "margin-top: 20px;" class= "btn btn-primary" id= "btn-submit" type="submit">Выбрать</button>
      <div id= "message" class="alert alert-info" style= "display: none;">
        Идет построение модели...<br>Этот процесс может занять несколько минут, пожалуйста, подождите. После завершения Вам будет предоставлена ссылка на страницу с результатами.
        Вы можете покинуть эту страницу, после завершения построенная модель с результатами появится в списке моделей текущего датасета.
      </div>
    </form>
    <div class= "side-info card" style= "width: 60%; margin-left: 10px;">
      <div class= "card-body">
        <h4>Описание методов</h4>
        <p>Тут будет описание доступных методов и их параметров.</p>
      </div>
    </div>
  </div>
{% endblock %}
{% block javascript %}
<script>
  $(document).on('submit', '#model_form',function(e){
    e.preventDefault()
    $.ajax({
        type:'POST',
        url:'{% url "add_model" pk=dataset_pk%}',
        data:{
            modelType:$('#id_modelType').val(),
            minClusters:$('#id_minClusters').val(),
            maxClusters:$('#id_maxClusters').val(),
            parameterSearchMethod:$('#id_parameterSearchMethod').val(),
            csrfmiddlewaretoken:$('input[name=csrfmiddlewaretoken]').val(),
            action: 'post'
        },
        success:function(data){
            console.log(data);
            showPreloader();
            waitForJobResult(data);
        },
        error : function(xhr,errmsg,err) {
        console.log(xhr.status + ": " + xhr.responseText); 
        }
    });
  });
  function checkJobResult(job_id, timerId, result_id) {
    $.ajax({
      type:'GET',
      url: '/toolapp/job_info/' + job_id + '/',
      success: function(job_info){
        let job_status = job_info.status;
        if (job_status == 'finished' || job_status == 'failed'){ 
          clearTimeout(timerId);
          if (job_status == 'finished'){
            showResultLink(result_id);
          }
          else showErrorMessage();
        }
      },
      error : function(xhr,errmsg,err) {
        console.log(xhr.status + ": " + xhr.responseText); 
      }
    });
  }
  function waitForJobResult(data) {
    let job_id = data.job_id;
    let result_id = data.result_pk;
    let timerId = setInterval(() => checkJobResult(job_id, timerId, result_id) , 10000);
  }
  function showResultLink(result_id){
    let btn = document.getElementById("btn-submit");
    btn.textContent = "Модель построена.";
    document.getElementById("message").innerHTML = "<a href='/toolapp/result/" + result_id + "'>Результаты</a>";
  }
  function showErrorMessage() {
    let btn = document.getElementById("btn-submit");
    btn.textContent = "Ошибка";
    document.getElementById("message").innerHTML = "Не удалось построить модель.";
  }
  document.getElementById("btn-params").addEventListener("click", showParameters);
  document.getElementById("id_modelType").addEventListener("change", changeParameters);
  function showPreloader() {
    let btn = document.getElementById("btn-submit");
    btn.setAttribute("class", "btn btn-primary disabled");
    btn.textContent = "Строим модель...";
    document.getElementById("message").style.display = "block";
  }
  function showParameters() {
    let icon = document.getElementById("btn-icon");
    let params = document.getElementById("model-params");
    if (icon.classList.contains("fa-chevron-down")) {
      icon.classList.remove("fa-chevron-down");
      icon.classList.add("fa-chevron-up");
      params.style.display = "block";
    }
    else {
      icon.classList.remove("fa-chevron-up");
      icon.classList.add("fa-chevron-down");
      params.style.display = "none";
    }
  }
  function changeParameters() {
    value = document.getElementById("id_modelType").value;
    let model1 = document.querySelectorAll(".model1");
    let model2 = document.querySelectorAll(".model2");
    let model3 = document.querySelectorAll(".model3");
    switch(value) {
      case "Кластеризация методом k-средних":
        for (let elem of model1) {
          elem.style.display = "block";
        }
        for (let elem of model2) {
          elem.style.display = "none";
        }
        for (let elem of model3) {
            elem.style.display = "none";
        }
        break;
      case "Кластеризация методом DBSCAN":
        for (let elem of model1) {
          elem.style.display = "none";
        }
        for (let elem of model2) {
          elem.style.display = "block";
        }
        for (let elem of model3) {
          elem.style.display = "none";
        }
        break;
      case "Классификация деревом решений":
      case "Классификация случайным лесом":
        for (let elem of model1) {
            elem.style.display = "none";
        }
        for (let elem of model2) {
            elem.style.display = "none";
        }
        for (let elem of model3) {
            elem.style.display = "block";
        }
        break;
    }  
  } 
</script>
{% endblock %}

